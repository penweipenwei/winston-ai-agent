<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>Winston çš„ AI Agent</title>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background: #f4f4f4; margin: 20px; padding-bottom: 200px; /* Add padding to prevent overlap by fixed agent */ }
        .section { background: white; padding: 20px; border-radius: 8px; margin-bottom: 30px; box-shadow: 0 0 5px rgba(0,0,0,0.1); }
        select, button, input, textarea { padding: 8px; font-size: 16px; margin: 10px 0; }
        .hidden { display: none; }
        #questionArea button, #feedbackArea button { margin-left: 10px; }

        /* --- Virtual Agent CSS --- */
        #virtualAgentContainer {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 450px; /* Adjusted width based on user feedback */
            z-index: 1000;
            border: 2px solid #ccc;
            border-radius: 10px;
            background-color: #f9f9f9;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        #virtualAgentContainer img {
            width: 100%;
            height: auto;
            display: block;
        }
        /* --- End Virtual Agent CSS --- */
    </style>
</head>
<body>

<div class="section">
    <h2>ğŸ“° æ–°èæ‘˜è¦ + èªéŸ³æ’­æ”¾</h2>
    <label for="categorySelect">é¸æ“‡é¡åˆ¥ï¼š</label>
    <select id="categorySelect">
        <option value="general">ç¶œåˆ</option>
        <option value="world">åœ‹éš›</option>
        <option value="technology">ç§‘æŠ€</option>
        <option value="nation">åœ‹å…§</option>
        <option value="business">å•†æ¥­</option>
        <option value="sports">é«”è‚²</option>
        <option value="science">ç§‘å­¸</option>
        <option value="health">å¥åº·</option>
    </select>
    <button onclick="loadNews()">è¼‰å…¥æ–°è</button>
    <div id="newsArea"></div>
</div>

<div class="section">
    <h2>ğŸ“˜ æ•¸å­¸æ™ºæ…§å‡ºé¡Œ + èªéŸ³æ’­æ”¾</h2>
    <label for="unitSelect">é¸æ“‡å–®å…ƒå°ç¯€ï¼š</label>
    <select id="unitSelect"></select>
    <button onclick="generateQuestion()">å‡ºé¡Œ</button>

    <div id="questionArea" style="margin-top:20px;">
        <p><strong>é¡Œç›®ï¼š</strong><span id="questionText">(è«‹å…ˆé»å‡ºé¡Œ)</span> <button onclick="speakQuestion()">ğŸ”Š æœ—è®€é¡Œç›®</button></p>
        <div id="questionAudioContainer" style="margin-top: 5px;"></div>
        <p id="correctAnswerParagraph" class="hidden"><strong>æ­£ç¢ºç­”æ¡ˆï¼š</strong><span id="answerText"></span></p>
        <p id="explanationParagraph" class="hidden"><strong>è§£èªªï¼š</strong><span id="explanationText"></span></p>
    </div>
</div>

<div class="section">
    <h2>âœï¸ ä½œç­”å€</h2>
    <textarea id="userAnswer" placeholder="è«‹è¼¸å…¥ä½ çš„ç­”æ¡ˆ" rows="3" style="width: 80%; margin-bottom: 10px;"></textarea>
    <button onclick="submitAnswer()">æäº¤ç­”æ¡ˆ</button>
    <div id="feedbackArea" style="margin-top: 10px; font-weight: bold;">
        {/* Structure will be set by window.onload to include the audio container */}
    </div>
</div>

<div id="virtualAgentContainer">
    <img id="agentImage" src="/static/images/agent_idle.png" alt="AI Agent">
</div>
<script>
let currentMathQuestion = "";
let originalAnswer = "";
let originalExplanation = "";
let currentExplanation = "";

// --- Virtual Agent JavaScript ---
const agentImageElement = document.getElementById('agentImage');
const agentIdleImg = "/static/images/agent_idle.png";
const agentSpeakingFrames = [
    "/static/images/agent_speaking_closed.png",
    "/static/images/agent_speaking_half.png",
    "/static/images/agent_speaking_open.png",
    "/static/images/agent_speaking_half.png"
];

let speakingAnimationInterval;
let idleAnimationInterval;
let currentSpeakingFrame = 0;
let isSpeaking = false;

function setAgentImage(src) {
    if (agentImageElement) {
        agentImageElement.src = src;
    }
}

function prepareToSpeak() {
    if (isSpeaking) return;
    isSpeaking = true;
    clearInterval(idleAnimationInterval);
    setAgentImage(agentSpeakingFrames[0]);
}

function animateSpeaking() {
    if (!isSpeaking) return;
    clearInterval(speakingAnimationInterval);

    currentSpeakingFrame = 0;
    setAgentImage(agentSpeakingFrames[currentSpeakingFrame]);

    speakingAnimationInterval = setInterval(() => {
        currentSpeakingFrame = (currentSpeakingFrame + 1) % agentSpeakingFrames.length;
        setAgentImage(agentSpeakingFrames[currentSpeakingFrame]);
    }, 150);
}


function stopSpeakingAnimation() {
    isSpeaking = false;
    clearInterval(speakingAnimationInterval);
    setAgentImage(agentIdleImg);
    startIdleAnimation();
}

function startIdleAnimation() {
    if (isSpeaking) return;
    clearInterval(idleAnimationInterval);
    setAgentImage(agentIdleImg);

    idleAnimationInterval = setInterval(() => {
        if (isSpeaking) {
            clearInterval(idleAnimationInterval);
            return;
        }
        setAgentImage(agentSpeakingFrames[0]);
        setTimeout(() => {
            if (!isSpeaking) setAgentImage(agentIdleImg);
        }, 150);
    }, 5000);
}
// --- End Virtual Agent JavaScript ---


async function loadUnits() {
    try {
        const res = await fetch('/get-math-units');
        const units = await res.json();
        const select = document.getElementById("unitSelect");
        select.innerHTML = "";

        if (units && units.length > 0) {
            units.forEach(unit => {
                const opt = document.createElement("option");
                opt.value = unit;
                opt.textContent = unit;
                select.appendChild(opt);
            });
        } else {
            const opt = document.createElement("option");
            opt.textContent = "ç„¡å¯ç”¨å–®å…ƒ";
            opt.disabled = true;
            select.appendChild(opt);
        }
    } catch (error) {
        const select = document.getElementById("unitSelect");
        select.innerHTML = "";
        const opt = document.createElement("option");
        opt.textContent = "è¼‰å…¥å–®å…ƒå¤±æ•—";
        opt.disabled = true;
        select.appendChild(opt);
        console.error("å–®å…ƒè¼‰å…¥å¤±æ•—ï¼š", error);
    }
}

async function generateQuestion() {
    const unitSelect = document.getElementById("unitSelect");
    const questionTextSpan = document.getElementById("questionText");
    const answerTextSpan = document.getElementById("answerText");
    const explanationTextSpan = document.getElementById("explanationText");
    const feedbackTextSpan = document.getElementById("feedbackText");
    const userAnswerTextarea = document.getElementById("userAnswer");
    const correctAnswerParagraph = document.getElementById("correctAnswerParagraph");
    const explanationParagraph = document.getElementById("explanationParagraph");
    const questionAudioContainer = document.getElementById("questionAudioContainer");
    const explanationAudioContainer = document.getElementById("explanationAudioContainer");


    if (!unitSelect.value || unitSelect.options?.[unitSelect.selectedIndex]?.disabled) {
        questionTextSpan.textContent = "(è«‹å…ˆé¸æ“‡ä¸€å€‹æœ‰æ•ˆçš„å–®å…ƒ)";
        answerTextSpan.textContent = "";
        explanationTextSpan.textContent = "";
        if(feedbackTextSpan) feedbackTextSpan.textContent = "";
        currentMathQuestion = "";
        originalAnswer = "";
        originalExplanation = "";
        currentExplanation = "";
        correctAnswerParagraph.classList.add("hidden");
        explanationParagraph.classList.add("hidden");
        if(questionAudioContainer) questionAudioContainer.innerHTML = "";
        if(explanationAudioContainer) explanationAudioContainer.innerHTML = "";
        return;
    }
    const unit = unitSelect.value;
    const cacheBuster = "&t=" + new Date().getTime();

    questionTextSpan.textContent = "æ­£åœ¨å‡ºé¡Œä¸­...";
    answerTextSpan.textContent = "";
    explanationTextSpan.textContent = "";
    if(feedbackTextSpan) feedbackTextSpan.textContent = "";
    userAnswerTextarea.value = "";
    correctAnswerParagraph.classList.add("hidden");
    explanationParagraph.classList.add("hidden");
    if(questionAudioContainer) questionAudioContainer.innerHTML = "";
    if(explanationAudioContainer) explanationAudioContainer.innerHTML = "";


    try {
        const res = await fetch(`/generate-math-question?unit=${encodeURIComponent(unit)}${cacheBuster}`);
        const data = await res.json();

        currentMathQuestion = data.question || "";
        originalAnswer = data.answer || "";
        originalExplanation = data.explanation || "";
        questionTextSpan.textContent = currentMathQuestion || "(ç„¡æ³•ç”¢ç”Ÿé¡Œç›®)";
        answerTextSpan.textContent = "";
        explanationTextSpan.textContent = "";

    } catch (error) {
        console.error("å‡ºé¡Œå¤±æ•—:", error);
        questionTextSpan.textContent = "(å‡ºé¡Œæ™‚ç™¼ç”ŸéŒ¯èª¤)";
        currentMathQuestion = "";
        originalAnswer = "";
        originalExplanation = "";
        currentExplanation = "";
    }
}

async function submitAnswer() {
    const userAnswer = document.getElementById("userAnswer").value;
    const feedbackTextSpan = document.getElementById("feedbackText");
    const answerTextSpan = document.getElementById("answerText");
    const explanationTextSpan = document.getElementById("explanationText");
    const correctAnswerParagraph = document.getElementById("correctAnswerParagraph");
    const explanationParagraph = document.getElementById("explanationParagraph");
    const explanationAudioContainer = document.getElementById("explanationAudioContainer");

    if (!currentMathQuestion) {
        if(feedbackTextSpan) feedbackTextSpan.textContent = "è«‹å…ˆå‡ºé¡Œå¾Œå†æäº¤ç­”æ¡ˆã€‚";
        currentExplanation = "";
        return;
    }
    if (!userAnswer.trim()) {
        if(feedbackTextSpan) feedbackTextSpan.textContent = "è«‹è¼¸å…¥æ‚¨çš„ç­”æ¡ˆã€‚";
        currentExplanation = "";
        return;
    }

    if(feedbackTextSpan) feedbackTextSpan.textContent = "æ­£åœ¨æª¢æŸ¥ç­”æ¡ˆ...";
    currentExplanation = "";
    if(explanationAudioContainer) explanationAudioContainer.innerHTML = "";

    try {
        const res = await fetch(`/check-answer`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                question: currentMathQuestion,
                answer: userAnswer
            }),
        });
        const data = await res.json();

        currentExplanation = data.explanation || "ç„¡æ³•ç²å–æ‰¹æ”¹çµæœã€‚";
        if(feedbackTextSpan) feedbackTextSpan.textContent = currentExplanation;
        answerTextSpan.textContent = "";
        explanationTextSpan.textContent = "";
        correctAnswerParagraph.classList.add("hidden");
        explanationParagraph.classList.add("hidden");

    } catch (error) {
        console.error("æäº¤ç­”æ¡ˆå¤±æ•—:", error);
        if(feedbackTextSpan) feedbackTextSpan.textContent = "æäº¤ç­”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚";
        currentExplanation = "";
    }
}

async function speakText(text, containerId) {
    if (!text) {
        console.warn("æ²’æœ‰æ–‡å­—å¯ä»¥æœ—è®€ã€‚");
        return;
    }

    const audioBox = document.getElementById(containerId);
    if (!audioBox) {
        console.error("æ‰¾ä¸åˆ°éŸ³è¨Šå®¹å™¨:", containerId);
        return;
    }
    audioBox.innerHTML = "æ­£åœ¨æº–å‚™èªéŸ³...";
    prepareToSpeak();

    try {
        const res = await fetch('/play-news-tts', {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ text: text })
        });
        const data = await res.json();

        if (data.audio_url) {
            const audioUrlWithCacheBuster = data.audio_url + "?t=" + new Date().getTime();
            const audio = document.createElement("audio");
            audio.src = audioUrlWithCacheBuster;

            let hasPlayed = false;

            const playHandler = () => {
                if (!hasPlayed && isSpeaking) {
                    audioBox.innerHTML = "";
                    audioBox.appendChild(audio);
                    audio.controls = true;
                    audio.play().then(() => {
                        animateSpeaking();
                        console.log("éŸ³è¨Šé–‹å§‹æ’­æ”¾ï¼Œå•Ÿå‹•å˜´å‹å‹•ç•«:", audioUrlWithCacheBuster, "æ–¼å®¹å™¨:", containerId);
                    }).catch(e => {
                        console.error("éŸ³è¨Šæ’­æ”¾å‘½ä»¤å¤±æ•—:", e);
                        stopSpeakingAnimation();
                        audioBox.innerHTML = "<p style='color:red;'>éŸ³è¨Šç„¡æ³•è‡ªå‹•æ’­æ”¾ã€‚</p>";
                    });
                    hasPlayed = true;
                }
            };

            audio.addEventListener('canplaythrough', playHandler);
            audio.addEventListener('play', playHandler);


            audio.onended = () => {
                stopSpeakingAnimation();
            };
            audio.onerror = (e) => {
                console.error("éŸ³è¨Šæ’­æ”¾éŒ¯èª¤:", e);
                stopSpeakingAnimation();
                audioBox.innerHTML = "<p style='color:red;'>éŸ³è¨Šæ’­æ”¾å¤±æ•—ã€‚</p>";
            };
            audio.load();
        } else if (data.error) {
            console.error("æœ—è®€å¤±æ•— (API):", data.error);
            audioBox.innerHTML = `<p style='color:red;'>æœ—è®€å¤±æ•—: ${data.error}</p>`;
            stopSpeakingAnimation();
        } else {
            console.warn("æœ—è®€è«‹æ±‚æˆåŠŸï¼Œä½†æ²’æœ‰æ”¶åˆ°éŸ³è¨Š URLã€‚");
            audioBox.innerHTML = "<p style='color:orange;'>æœ—è®€å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</p>";
            stopSpeakingAnimation();
        }
    } catch (error) {
        console.error("æœ—è®€æ™‚ç™¼ç”Ÿç¶²è·¯æˆ–FetchéŒ¯èª¤:", error);
        audioBox.innerHTML = "<p style='color:red;'>æœ—è®€æ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚</p>";
        stopSpeakingAnimation();
    }
}


function speakQuestion() {
    const questionAudioContainer = document.getElementById("questionAudioContainer");
    if(questionAudioContainer) questionAudioContainer.innerHTML = "";
    speakText(currentMathQuestion, "questionAudioContainer");
}

function speakExplanation() {
    const explanationAudioContainer = document.getElementById("explanationAudioContainer");
    if(explanationAudioContainer) explanationAudioContainer.innerHTML = "";
    speakText(currentExplanation, "explanationAudioContainer");
}

async function loadNews() {
    const category = document.getElementById("categorySelect").value;
    const newsArea = document.getElementById("newsArea");
    newsArea.innerHTML = "æ­£åœ¨è¼‰å…¥æ–°è...";

    try {
        const res = await fetch(`/get-news?category=${encodeURIComponent(category)}`);
        const data = await res.json();
        newsArea.innerHTML = "";

        if (data.error) {
            newsArea.innerHTML = `<p style="color: red;">${data.error}</p>`;
            return;
        }

        if (data && data.length > 0) {
            data.forEach(newsItem => {
                const div = document.createElement("div");
                const audioContainerId = "audio_container_" + Math.random().toString(36).substring(2, 9);

                const title = document.createElement("h4");
                title.textContent = newsItem.title;
                div.appendChild(title);

                const summary = document.createElement("p");
                summary.textContent = newsItem.summary;
                div.appendChild(summary);

                const playButton = document.createElement("button");
                playButton.textContent = "ğŸ”Š æ’­æ”¾èªéŸ³";
                playButton.onclick = () => {
                    speakTextForNews(newsItem.summary, audioContainerId);
                };
                div.appendChild(playButton);

                const audioDiv = document.createElement("div");
                audioDiv.id = audioContainerId;
                div.appendChild(audioDiv);

                const hr = document.createElement("hr");
                div.appendChild(hr);
                newsArea.appendChild(div);
            });
        } else {
            newsArea.innerHTML = "<p>ç›®å‰æ²’æœ‰æ–°èå¯é¡¯ç¤ºã€‚</p>";
        }
    } catch (error) {
        console.error("è¼‰å…¥æ–°èå¤±æ•—:", error);
        newsArea.innerHTML = "<p>è¼‰å…¥æ–°èæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</p>";
    }
}

async function speakTextForNews(text, containerId) {
    if (!text) {
        console.warn("æ²’æœ‰æ–°èæ–‡å­—å¯ä»¥æœ—è®€ã€‚");
        return;
    }
    // For news, we use the same speakText logic to handle animation and audio in a container
    speakText(text, containerId);
}


window.onload = () => {
    loadUnits();
    const feedbackArea = document.getElementById("feedbackArea");
    feedbackArea.innerHTML = `<strong>AI å›è¦†ï¼š</strong><span id="feedbackText"></span>
                              <button onclick="speakExplanation()">ğŸ”Š æœ—è®€è§£èªª</button>
                              <div id="explanationAudioContainer" style="margin-top: 5px;"></div>`;
    startIdleAnimation();
};
</script>
</body>
</html>